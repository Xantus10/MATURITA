worker_processes 1;

events {
  worker_connections 1024;
}

http {

upstream frontend {
  server frontend:3000;
}

upstream backend {
  server backend:5000;
}

server {
  listen 80;

  server_name localhost;

  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl;

  server_name localhost;

  ssl_certificate /etc/nginx/localhost.crt;
  ssl_certificate_key /etc/nginx/localhost.key;

  # HSTS once I have a normal valid cert
  #add_header Strict-Transport-Security "max-age=63072000; preload" always;
  add_header X-Frame-Options "DENY" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
  add_header Cross-Origin-Opener-Policy "same-origin-allow-popups" always;

  add_header Content-Security-Policy "default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;" always;
  
#  add_header Content-Security-Policy "
#    default-src 'self';
#    script-src 'self';
#    style-src 'self' 'unsafe-inline';
#    img-src 'self' data:;
#    font-src 'self';
#    connect-src 'self'
#        https://login.microsoftonline.com
#        https://graph.microsoft.com;
#    frame-src https://login.microsoftonline.com;
#    frame-ancestors 'none';
#" always;

  location /api/ {
    rewrite /api/(.*) /$1 break;
    proxy_pass http://backend;
    proxy_hide_header ETag;
    add_header Cache-Control 'no-store';
  }

  location /images/ {
    proxy_pass http://backend;
  }

  location /assets/ {
    proxy_pass http://frontend;
  }

  location /locales/ {
    proxy_pass http://frontend;
  }

  location /favicon.ico {
    proxy_pass http://frontend;
  }

  location / {
    proxy_pass http://frontend;
    error_page 404 /index.html;
  }

#  location /sockjs-node {
#    proxy_pass http://frontend;
#    proxy_http_version 1.1;
#    proxy_set_header Upgrade $http_upgrade;
#    proxy_set_header Connection "Upgrade";
#}
}
}